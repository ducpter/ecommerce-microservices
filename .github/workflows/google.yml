name: 'Build and Deploy to GKE'

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: 'silicon-airlock-456802-p4'
  GAR_LOCATION: 'asia-southeast1'
  GKE_CLUSTER: 'ecommerce'
  GKE_ZONE: 'asia-southeast1'
  DEPLOYMENT_NAME: 'gke-test'
  REPOSITORY: 'samples'
  IMAGE: 'static-site'

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source code
      - name: 'Checkout source code'
        uses: actions/checkout@v3

      # 2. Authenticate to Google Cloud using Service Account
      - name: 'Authenticate to GCP with Service Account'
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3. Set up gcloud CLI
      - name: 'Set up gcloud CLI'
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.PROJECT_ID }}

      # 3.1. Configure Docker to use Artifact Registry credentials
      - name: 'Configure Docker for Artifact Registry'
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      # 4. Get GKE cluster credentials
      - name: 'Get GKE credentials'
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_ZONE }}

      # Build JAR for api-gateway
      - name: Build JAR for api-gateway
        run: |
          cd api-gateway
          mvn -B -DskipTests package
          cd ..

      - name: 'Build and push Docker image for api-gateway'
        run: |
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api-gateway:${{ github.sha }}"
          cd api-gateway
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          cd ..
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          GAR_LOCATION: ${{ env.GAR_LOCATION }}
          REPOSITORY: ${{ env.REPOSITORY }}

      # Build JAR for discovery-server
      - name: Build JAR for discovery-server
        run: |
          cd discovery-server
          mvn -B -DskipTests package
          cd ..

      - name: 'Build and push Docker image for discovery-server'
        run: |
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/discovery-server:${{ github.sha }}"
          cd discovery-server
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          cd ..
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          GAR_LOCATION: ${{ env.GAR_LOCATION }}
          REPOSITORY: ${{ env.REPOSITORY }}

      # Build JAR for product-service
      - name: Build JAR for product-service
        run: |
          cd product-service
          mvn -B -DskipTests package
          cd ..

      - name: 'Build and push Docker image for product-service'
        run: |
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/product-service:${{ github.sha }}"
          cd product-service
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          cd ..
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          GAR_LOCATION: ${{ env.GAR_LOCATION }}
          REPOSITORY: ${{ env.REPOSITORY }}

      # Build JAR for order-service
      - name: Build JAR for order-service
        run: |
          cd order-service
          mvn -B -DskipTests package
          cd ..

      - name: 'Build and push Docker image for order-service'
        run: |
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/order-service:${{ github.sha }}"
          cd order-service
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          cd ..
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          GAR_LOCATION: ${{ env.GAR_LOCATION }}
          REPOSITORY: ${{ env.REPOSITORY }}

      # Build JAR for inventory-service
      - name: Build JAR for inventory-service
        run: |
          cd inventory-service
          mvn -B -DskipTests package
          cd ..

      - name: 'Build and push Docker image for inventory-service'
        run: |
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/inventory-service:${{ github.sha }}"
          cd inventory-service
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          cd ..
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          GAR_LOCATION: ${{ env.GAR_LOCATION }}
          REPOSITORY: ${{ env.REPOSITORY }}

      # Build JAR for notification-service
      - name: Build JAR for notification-service
        run: |
          cd notification-service
          mvn -B -DskipTests package
          cd ..

      - name: 'Build and push Docker image for notification-service'
        run: |
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/notification-service:${{ github.sha }}"
          cd notification-service
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          cd ..
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          GAR_LOCATION: ${{ env.GAR_LOCATION }}
          REPOSITORY: ${{ env.REPOSITORY }}

      # 6. Deploy to GKE
      - name: 'Deploy to GKE'
        run: |
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ github.sha }}"
          sed -i "s|image: .*|image: $IMAGE_URI|g" k8s/deployment.yaml
          kubectl apply -f k8s/
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }}
