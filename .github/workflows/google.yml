name: Deploy to GKE with Public Images

on:
  push:
    branches:
      - main # Trigger on push to the master branch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v2

      # Authenticate to GCP with Service Account
      - name: Authenticate to GCP with Service Account
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # Setup Google Cloud SDK
      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: 'silicon-airlock-456802-p4'

      # Connect to GKE Cluster
      - name: Connect to GKE Cluster
        run: |
          gcloud container clusters get-credentials ecommerce --region asia-southeast1


      # Install gke-gcloud-auth-plugin
      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet || true

      # Authenticate Docker with Google Cloud
      - name: Authenticate Docker
        run: gcloud auth configure-docker asia-southeast1-docker.pkg.dev

      # Build and push the Docker images for all services
      - name: Build and Push Docker Images
        env:
          GOOGLE_PROJECT: 'silicon-airlock-456802-p4'
        run: |
          # Build images for each service
          docker build --no-cache -t asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/api-gateway:latest ./api-gateway
          docker build --no-cache -t asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/discovery-server:latest ./discovery-server
          docker build --no-cache -t asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/product-service:latest ./product-service
          docker build --no-cache -t asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/order-service:latest ./order-service
          docker build --no-cache -t asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/inventory-service:latest ./inventory-service
          docker build --no-cache -t asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/notification-service:latest ./notification-service

          # Push images to Google Container Registry
          docker push asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/api-gateway:latest
          docker push asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/discovery-server:latest
          docker push asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/product-service:latest
          docker push asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/order-service:latest
          docker push asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/inventory-service:latest
          docker push asia-southeast1-docker.pkg.dev/silicon-airlock-456802-p4/samples/notification-service:latest
